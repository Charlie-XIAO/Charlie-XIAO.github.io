<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Fixing KernelDensity's handling of data variance in scikit-learn | Yao Xiao </title> <meta name="author" content="Yao Xiao"> <meta name="description" content="A deep dive into addressing the abnormal behavior of KernelDensity on non-unit variance data."> <meta name="keywords" content="Yao Xiao, Charlie-XIAO"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icons/code.png?3863ca35e11f521280544487379bc285"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://charlie-xiao.github.io/blog/2024/scikit-learn-kde/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yao Xiao </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/education/">Education </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">CV </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/assets/pdf/yxiao-cv/yxiao-cv.pdf">English</a> <a class="dropdown-item " href="/assets/pdf/yxiao-cv/yxiao-cv-verbose.pdf">English (Verbose)</a> <a class="dropdown-item " href="/assets/pdf/yxiao-cv/yxiao-cv-zh.pdf">中文</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link"><i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post single-page"> <header class="post-header"> <h1 class="post-title">Fixing KernelDensity's handling of data variance in scikit-learn</h1> <p class="post-meta"> Created on September 11, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/scikit-learn"> <i class="fa-solid fa-hashtag fa-sm"></i> scikit-learn</a>   ·   <a href="/blog/category/open-source"> <i class="fa-solid fa-tag fa-sm"></i> open-source</a> </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#problem-reproduction">Problem Reproduction</a></li> <li class="toc-entry toc-h2"><a href="#problem-analysis">Problem Analysis</a></li> <li class="toc-entry toc-h2"><a href="#proposed-solution">Proposed Solution</a></li> <li class="toc-entry toc-h2"><a href="#future-work">Future Work</a></li> </ul> </div> <hr> <div id="markdown-content"> <p>Scikit-learn has a tree-based implementation of kernel density estimation in <a href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KernelDensity.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">KernelDensity</code></a>. You may checkout <a href="https://jakevdp.github.io/blog/2013/12/01/kernel-density-estimation/" rel="external nofollow noopener" target="_blank">this post</a> by the original author. The tree-based implementation outperforms the naive implementation <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.gaussian_kde.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">gaussian_kde</code></a> in scipy, thus being suitable for large datasets.</p> <p>Yet as revealed in <a href="https://github.com/scikit-learn/scikit-learn/issues/25623" rel="external nofollow noopener" target="_blank">#25623</a> and <a href="https://github.com/scikit-learn/scikit-learn/issues/25623" rel="external nofollow noopener" target="_blank">#26658</a>, <code class="language-plaintext highlighter-rouge">KernelDensity</code> consistently gave incorrect results on data with non-unit variance. In this blog post we will go through the underlying issues and the corresponding fix.</p> <h2 id="problem-reproduction">Problem Reproduction</h2> <p>Let us begin with a simple example to reveal the problem. Here we draw samples from the normal distribution, but with different scales (i.e., standard deviations) 1, 0.1, and 10, and perform kernel density estimation respectively.</p> <div class="jupyter-notebook" style="position: relative; width: 100%; margin: 0 auto;"> <div class="jupyter-notebook-iframe-container"> <iframe src="/assets/jupyter/posts/scikit-learn-kde/incorrect-results.ipynb.html" style="position: absolute; top: 0; left: 0; border-style: none;" width="100%" height="100%" onload="this.parentElement.style.paddingBottom = (this.contentWindow.document.documentElement.scrollHeight + 10) + 'px'"></iframe> </div> </div> <p>As we can see from the plots, scikit-learn’s results were far from the underlying distribution for <code class="language-plaintext highlighter-rouge">scale=0.1</code> and <code class="language-plaintext highlighter-rouge">scale=10</code> while scipy gave reasonable estimations.</p> <h2 id="problem-analysis">Problem Analysis</h2> <p>We will start with the univariate case. By definition, let \((x_1,\ldots,x_n)\) be independent and identially distributed samples drawn from some univariate distribution, its kernel density estimator at a given point \(x\) is</p> \[\hat{f}_h(x)=\frac{1}{n}\sum_{i=1}^nK_h(x-x_i)=\frac{1}{nh}\sum_{i=1}^nK\left(\frac{x-x_i}{h}\right),\] <p>where \(K\) is the kernel function and \(h\) is the <strong>bandwidth</strong>. <em>This is exactly how scikit-learn implemented kernel density estimation,</em> but a good bandwidth should be chosen proportional to the standard deviation of data. If we use Scott’s or Silverman’s rule of thumb (as in the example above) for automatic bandwidth selection, it does not take into account data variance. Thus for <code class="language-plaintext highlighter-rouge">scale=0.1</code>, the chosen bandwidth would be too large and over-smoothens the estimation, and for <code class="language-plaintext highlighter-rouge">scale=10</code>, the chosen bandwidth would be too small causing the estimation to be too sensitive to noise.</p> <p>Moreover in scipy’s context, the <code class="language-plaintext highlighter-rouge">bw_method</code> parameter (equivalent to scikit-learn’s <code class="language-plaintext highlighter-rouge">bandwidth</code> parameter) does not directly give the \(h\) as in the formula. It is scaled to adapt to the variance of data, or equivalently, the data is scaled to unit variance before applying the formula above, which aligns with the analysis above.</p> <p>What about multivariate data? The formula is similar, such that</p> \[\hat{f}_H(\mathbf{x})=\frac{1}{n}\sum_{i=1}^nK_H(\mathbf{x}-\mathbf{x}_i)=\frac{1}{n|H|}\sum_{i=1}^nK\left(H^{-1}(\mathbf{x}-\mathbf{x}_i)\right),\] <p>except that this time we have a bandwidth matrix. Also similar to the univariate case, a good bandwidth matrix should be chosen proportional to \(\Sigma^{1/2}\) where \(\Sigma\) is the covariance matrix of data. In other words, the bandwidth in each dimension should have unit variance. Otherwise, the same thing as in the univariate case will happen per dimension.</p> <h2 id="proposed-solution">Proposed Solution</h2> <p>The issue is not hard to solve, but to first summarize our analysis, we want the <code class="language-plaintext highlighter-rouge">bandwidth</code> parameter to be properly scaled before estimation because:</p> <ul> <li>We want to respect the rules of thumb, e.g., Scott’s rule and Silverman’s rule.</li> <li>We want to be consistent with other scientific Python libraries like <code class="language-plaintext highlighter-rouge">scipy</code> and <code class="language-plaintext highlighter-rouge">statsmodels</code> to avoid confusion of users.</li> <li>We want to make the API easy-to-use. In particular, there is no clear reason to let users manually handle data variance when choosing bandwidth, especially in the multivariate case where users would even need to choose a bandwidth vector if the scaling is not performed internally.</li> </ul> <p>Let \(h\) now be the <code class="language-plaintext highlighter-rouge">bandwidth</code> parameter (i.e., before scaling), then we can rewrite the formula into</p> \[\hat{f}_h(\mathbf{x})=\frac{1}{nh|\Sigma^{-1/2}|}\sum_{i=1}^nK\left(\frac{\Sigma^{-1}(\mathbf{x}-\mathbf{x}_i)}{h}\right).\] <p>Compared with the previous (incorrect) implementation</p> \[\hat{f}_h(\mathbf{x})=\frac{1}{nh}\sum_{i=1}^nK\left(\frac{\mathbf{x}-\mathbf{x}_i}{h}\right),\] <p>it suffices to (1) input \(\Sigma^{-1/2}\mathbf{x}\) instead of \(\mathbf{x}\), and (2) divide by \(\Sigma^{-1/2}\) for the output. Note that \(\Sigma^{1/2}\) can be computed from the covariance matrix (<code class="language-plaintext highlighter-rouge">np.cov</code>) with Cholesky decomposition (<code class="language-plaintext highlighter-rouge">scipy.linalg.cholesky</code>), so \(\mathbf{v}=\Sigma^{-1/2}\mathbf{x}\) can be obtained by simply solving \(\Sigma^{1/2}\cdot\mathbf{v}=\mathbf{x}\) (<code class="language-plaintext highlighter-rouge">scipy.linalg.solve_triangular</code>).</p> <p>You may want to check out the actual fix in <a href="https://github.com/scikit-learn/scikit-learn/pull/27971" rel="external nofollow noopener" target="_blank">#27971</a> as well.</p> <h2 id="future-work">Future Work</h2> <ul> <li> <p>There is another potential issue <a href="https://github.com/scikit-learn/scikit-learn/issues/27186" rel="external nofollow noopener" target="_blank">#27186</a> in the scikit-learn tree-based implementation, which is not yet confirmed as it has not revealed any unexpected behavior in practice.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">sample_weight</code> support (originally implemented in <a href="https://github.com/scikit-learn/scikit-learn/pull/10803" rel="external nofollow noopener" target="_blank">#10803</a>) in kernel density estimation is unexpectedly slow. The tree-based implementation of scikit-learn was meant to be faster than the naive implementation of <code class="language-plaintext highlighter-rouge">scipy</code>, but with <code class="language-plaintext highlighter-rouge">sample_weight</code> it is several or tens of times slower, even if we allow some tolerance.</p> </li> </ul> </div> </article> <div id="giscus_thread" style="max-width: 960px; margin: 0 auto;"> <script>
      let giscusTheme = determineComputedTheme();
      let giscusAttributes = {
        src: 'https://giscus.app/client.js',
        'data-repo': 'Charlie-XIAO/Charlie-XIAO.github.io',
        'data-repo-id': 'R_kgDOMkP9Mw',
        'data-category': 'Comments',
        'data-category-id': 'DIC_kwDOMkP9M84CiXqg',
        'data-mapping': 'title',
        'data-strict': '1',
        'data-reactions-enabled': '1',
        'data-emit-metadata': '0',
        'data-input-position': 'bottom',
        'data-theme': giscusTheme,
        'data-lang': 'en',
        crossorigin: 'anonymous',
        async: '',
      };

      let giscusScript = document.createElement('script');
      Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
      document.getElementById('giscus_thread').appendChild(giscusScript);
    </script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Yao Xiao. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a> from <a href="https://github.com/Charlie-XIAO/Charlie-XIAO.github.io" rel="external nofollow noopener" target="_blank">GitHub</a>. Last updated: March 23, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?cf3e45730984e3eeb7db54a726f41eef"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>